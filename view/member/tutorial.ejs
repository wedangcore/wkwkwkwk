<%- include('./partials/header') %>

<style>
    .step-card {
        margin-bottom: 2.5rem;
    }
    .step-image-container {
        border-radius: 0.75rem;
        overflow: hidden;
        border: 1px solid var(--bs-border-color);
        box-shadow: var(--card-shadow);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .step-image {
        width: 100%;
        height: auto;
        display: block;
    }
    .img-horizontal {
        max-height: 400px;
        object-fit: cover;
    }
    .img-vertical {
        max-height: 550px;
        object-fit: contain;
        background-color: var(--bs-body-bg);
    }
    .video-container {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        height: 0;
        overflow: hidden;
        max-width: 100%;
        background: #000;
        border-radius: 0.75rem;
    }
    .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Tutorial Pengaturan Notifikasi</h1>
</div>
<p class="lead text-muted">Ikuti langkah-langkah di bawah ini untuk menghubungkan notifikasi transaksi dari aplikasi pembayaran ke sistem PayGateway menggunakan MacroDroid.</p>
<hr class="mb-5">

<div class="container-fluid px-0">

    <div class="row g-4 step-card align-items-center">
        <div class="col-lg-5">
            <h3 class="h4"><span class="badge bg-primary rounded-pill me-2">1</span> Siapkan Metode Pembayaran</h3>
            <p>Pastikan Anda sudah mengaktifkan metode pembayaran yang ingin digunakan (QRIS, E-Wallet, atau Bank) di halaman <a href="/member/payment">Manajemen Pembayaran</a>.</p>
        </div>
        <div class="col-lg-7"><div class="step-image-container"><img src="https://cdn.wbk.web.id/files/WBK-PayGateway__1_.png" class="step-image img-horizontal" alt="Langkah 1"></div></div>
    </div>
    <div class="row g-4 step-card align-items-center">
        <div class="col-lg-5">
            <h3 class="h4"><span class="badge bg-primary rounded-pill me-2">2</span> Salin API Key Anda</h3>
            <p>Buka halaman <a href="/member/profile">Profil Anda</a> dan salin APIKey yang tersedia. Kunci ini akan dimasukkan ke dalam file macro yang akan Anda unduh.</p>
        </div>
        <div class="col-lg-7"><div class="step-image-container"><img src="https://cdn.wbk.web.id/files/WBK-PayGateway__2_.png" class="step-image img-horizontal" alt="Langkah 2"></div></div>
    </div>
    <div class="row g-4 step-card align-items-center">
        <div class="col-lg-5">
            <h3 class="h4"><span class="badge bg-primary rounded-pill me-2">3</span> Unduh Aplikasi MacroDroid</h3>
            <p>Anda memerlukan aplikasi MacroDroid untuk menjalankan otomasi ini. Unduh dari <a href="https://play.google.com/store/apps/details?id=com.arlosoft.macrodroid" target="_blank">Google Play Store</a>.</p>
            <a href="https://play.google.com/store/apps/details?id=com.arlosoft.macrodroid" class="btn btn-success" target="_blank"><i class="bi bi-google-play me-2"></i>Unduh MacroDroid</a>
        </div>
        <div class="col-lg-7"><div class="step-image-container"><img src="https://cdn.wbk.web.id/files/WBK-PayGateway__3_.png" class="step-image img-horizontal" alt="Langkah 3"></div></div>
    </div>

    <div class="row g-4 step-card align-items-center">
        <div class="col-lg-5">
            <h3 class="h4"><span class="badge bg-primary rounded-pill me-2">4</span> Unduh Konfigurasi Universal</h3>
            <p>Pilih kategori pembayaran yang ingin Anda gunakan. File konfigurasi macro akan dibuat secara otomatis dengan API Key Anda dan siap untuk diunduh.</p>
             <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categorySelectionModal">
                <i class="bi bi-gear-fill me-2"></i>Pilih Kategori & Unduh
             </button>
        </div>
        <div class="col-lg-7"><div class="step-image-container"><img src="https://cdn.wbk.web.id/files/WBK-PayGateway__4_.png" class="step-image img-horizontal" alt="Langkah 4"></div></div>
    </div>
    
    <div class="row g-4 step-card align-items-center">
        <div class="col-lg-5">
            <h3 class="h4"><span class="badge bg-primary rounded-pill me-2">5</span> Buka & Impor File Macro</h3>
            <p>Setelah file 'WBK-Universal-Gateway.macro' diunduh, buka file tersebut dan pilih MacroDroid untuk mengimpor template.</p>
        </div>
        <div class="col-lg-7"><div class="step-image-container"><img src="https://cdn.wbk.web.id/files/WBK-PayGateway__6_.png" class="step-image img-horizontal" alt="Langkah 5"></div></div>
    </div>

    <div class="row g-4 step-card align-items-center">
        <div class="col-lg-5">
            <h3 class="h4"><span class="badge bg-primary rounded-pill me-2">6</span> Atur Pemicu & Simpan Macro</h3>
            <p>Langkah terakhir adalah mengatur aplikasi mana yang akan memicu notifikasi dan menyimpan macro. Untuk lebih jelasnya, silakan simak video panduan di samping.</p>
        </div>
        <div class="col-lg-7">
            <div class="video-container">
                <video controls preload="metadata">
                    <source src="https://cdn.wbk.web.id/files/lv_0_20250804173642.mp4" type="video/mp4">
                    Browser Anda tidak mendukung tag video.
                </video>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="categorySelectionModal" tabindex="-1" aria-labelledby="categorySelectionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="categorySelectionModalLabel">Pilih Kategori Pembayaran</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="download-form" action="/member/tutorial/macrodroid/download" method="POST">
          <div class="modal-body">
            <p class="small text-muted">Pilih salah satu kategori pembayaran yang sudah Anda aktifkan untuk disertakan dalam konfigurasi.</p>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">

            <% if (configuredMethods.hasQris) { %>
            <div class="form-check">
              <input class="form-check-input category-check" type="radio" name="cats" value="qris" id="cat-qris">
              <label class="form-check-label" for="cat-qris"><strong>QRIS</strong></label>
            </div>
            <% } %>

            <% if (configuredMethods.hasEwallet) { %>
            <div class="form-check">
              <input class="form-check-input category-check" type="radio" name="cats" value="ewallet" id="cat-ewallet">
              <label class="form-check-label" for="cat-ewallet"><strong>E-Wallet</strong></label>
            </div>
            <% } %>

            <% if (configuredMethods.hasBank) { %>
            <div class="form-check">
              <input class="form-check-input category-check" type="radio" name="cats" value="bank" id="cat-bank">
              <label class="form-check-label" for="cat-bank"><strong>Bank</strong></label>
            </div>
            <% } %>
            
            <% if (!configuredMethods.hasQris && !configuredMethods.hasEwallet && !configuredMethods.hasBank) { %>
                <p class="text-danger text-center small">Anda belum mengaktifkan metode pembayaran apapun. Silakan aktifkan di halaman <a href="/member/payment">Manajemen Pembayaran</a>.</p>
            <% } %>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="button" id="openConfirmModalBtn" class="btn btn-primary" disabled><i class="bi bi-download me-2"></i>Unduh File</button>
          </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="confirmDownloadModal" tabindex="-1" aria-labelledby="confirmDownloadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDownloadModalLabel">Konfirmasi Konfigurasi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <p>Konfigurasi yang akan Anda unduh bersifat **universal** dan **belum termasuk pemicu aplikasi pembayaran**.</p>
          <p class="mb-0">Setelah mengimpor, Anda perlu **mengatur pemicu secara manual** di dalam MacroDroid dengan memilih aplikasi notifikasi yang Anda gunakan (contoh: DANA, GoPay Merchant, dll) seperti yang dijelaskan pada video panduan.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#categorySelectionModal">Kembali</button>
        <button type="button" id="confirmDownloadBtn" class="btn btn-primary">Konfirmasi & Unduh</button>
      </div>
    </div>
  </div>
</div>

<script>
    // Javascript tidak berubah
    document.addEventListener('DOMContentLoaded', function () {
        const categoryRadios = document.querySelectorAll('.category-check');
        const openConfirmBtn = document.getElementById('openConfirmModalBtn');
        const confirmDownloadBtn = document.getElementById('confirmDownloadBtn');
        const downloadForm = document.getElementById('download-form');
        
        const categoryModal = new bootstrap.Modal(document.getElementById('categorySelectionModal'));
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmDownloadModal'));

        function toggleDownloadButton() {
            const anyCategoryChecked = Array.from(categoryRadios).some(c => c.checked);
            openConfirmBtn.disabled = !anyCategoryChecked;
        }

        categoryRadios.forEach(radio => {
            radio.addEventListener('change', toggleDownloadButton);
        });

        openConfirmBtn.addEventListener('click', () => {
            categoryModal.hide();
            confirmModal.show();
        });

        confirmDownloadBtn.addEventListener('click', () => {
            downloadForm.submit();
        });
    });
</script>

<%- include('./partials/footer') %>