<%- include('./partials/header') %>

<% if (success_messages.length > 0) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i><%= success_messages[0] %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
<% } %>
<% if (error_messages.length > 0) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i><%= error_messages[0] %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
<% } %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <h1 class="h2">Riwayat Transaksi</h1>
</div>

<div class="card mb-4">
    <div class="card-body p-3">
        <div class="row g-3 text-center mb-3">
            <div class="col-6 col-md-3">
                <small class="text-muted d-block">Trx Total</small>
                <h6 class="fw-bold mb-0"><%= user.transaksi.total || 0 %></h6>
            </div>
            <div class="col-6 col-md-3">
                <small class="text-muted d-block">Trx Sukses</small>
                <h6 class="fw-bold mb-0"><%= user.transaksi.sukses || 0 %></h6>
            </div>
            <div class="col-6 col-md-3">
                <small class="text-muted d-block">Trx Pending</small>
                <h6 class="fw-bold mb-0"><%= user.transaksi.pending || 0 %></h6>
            </div>
            <div class="col-6 col-md-3">
                <small class="text-muted d-block">Trx Gagal</small>
                <h6 class="fw-bold mb-0"><%= user.transaksi.gagal || 0 %></h6>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-12">
                <div class="bg-success-subtle rounded-2 p-2 text-center">
                    <small class="text-muted d-block">Total Omset Sukses</small>
                    <h6 class="fw-bold mb-0 text-success-emphasis"><%= new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(user.transaksi.omset_total || 0) %></h6>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="bg-primary-subtle rounded-2 p-2 text-center">
                    <small class="text-muted d-block">Total Uang Diterima</small>
                    <h6 class="fw-bold mb-0 text-primary-emphasis"><%= new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(user.transaksi.uang_sukses_total || 0) %></h6>
                </div>
            </div>
        </div>
    </div>
</div>

<% if (user.riwayatTransaksi && user.riwayatTransaksi.length > 0) { %>
    <% const sortedTransactions = user.riwayatTransaksi.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); %>

    <div class="d-none d-lg-block">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">ID Transaksi</th>
                                <th scope="col">Total Bayar</th>
                                <th scope="col">Metode</th>
                                <th scope="col">Tanggal</th>
                                <th scope="col" class="text-center">Status</th>
                                <th scope="col" class="text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% sortedTransactions.forEach(tx => { %>
                                <tr class="main-row">
                                    <td><code class="fw-semibold"><%= tx.transactionId %></code></td>
                                    <td class="fw-bold"><%= new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(tx.amount) %></td>
                                    <td><span class="badge bg-primary-subtle text-primary-emphasis"><%= tx.paymentMethod %></span></td>
                                    <td><%= new Date(tx.createdAt).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) %></td>
                                    <td class="text-center">
                                        <% if (tx.status === 'sukses') { %>
                                            <span class="badge bg-success-subtle text-success-emphasis">Sukses</span>
                                        <% } else if (tx.status === 'pending') { %>
                                            <span class="badge bg-warning-subtle text-warning-emphasis">Pending</span>
                                        <% } else { %>
                                            <span class="badge bg-danger-subtle text-danger-emphasis">Gagal</span>
                                        <% } %>
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center align-items-center gap-2">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#details-desktop-<%= tx.transactionId %>" aria-expanded="false">
                                                <i class="bi bi-info-circle"></i> Detail
                                            </button>
                                            <% if (tx.status === 'pending') { %>
                                                <form action="/member/transaction/update/<%= tx.transactionId %>" method="POST" style="min-width: 120px;">
                                                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                                    <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                                                        <option value="pending" selected>Ubah Status</option>
                                                        <option value="sukses">Sukses</option>
                                                        <option value="gagal">Gagal</option>
                                                    </select>
                                                </form>
                                            <% } %>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="detail-row">
                                    <td colspan="6" class="p-0" style="border: 0;">
                                        <div class="collapse" id="details-desktop-<%= tx.transactionId %>">
                                            <div class="d-flex flex-wrap p-3 bg-light-subtle">
                                                <div class="col-12 col-md-6 pe-md-3">
                                                    <h6 class="mb-3">Rincian Pembayaran</h6>
                                                    <ul class="list-group list-group-flush">
                                                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">Deskripsi<span><%= tx.description %></span></li>
                                                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">Jumlah Dasar<span><%= new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(tx.baseAmount || 0) %></span></li>
                                                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">Biaya Admin<span><%= new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(tx.feeAmount || 0) %></span></li>
                                                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">Kode Unik<span><%= new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(tx.uniqueNumber || 0) %></span></li>
                                                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent fw-bold">Total Bayar<span><%= new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(tx.amount) %></span></li>
                                                        <% if (tx.status === 'pending' && tx.expiredAt) { %>
                                                            <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent text-danger">Kedaluwarsa Pada<span><%= new Date(tx.expiredAt).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) %></span></li>
                                                        <% } %>
                                                        <% if (tx.paymentUrl) { %>
                                                            <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">
                                                                URL Pembayaran
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <a href="<%= tx.paymentUrl %>" target="_blank" class="btn btn-sm btn-outline-primary">Buka</a>
                                                                    <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('<%= tx.paymentUrl %>', this)">
                                                                        <i class="bi bi-copy"></i> Salin
                                                                    </button>
                                                                </div>
                                                            </li>
                                                        <% } %>
                                                    </ul>
                                                </div>
                                                <div class="col-12 col-md-6 ps-md-3 mt-3 mt-md-0">
                                                    <% if (tx.qr_url) { %>
                                                        <h6 class="mb-3">Data QRIS</h6>
                                                        <img src="<%= tx.qr_url %>" class="img-fluid rounded border mb-3" style="max-width: 200px;" alt="QRIS Code">
                                                        
                                                        <div class="mb-2">
                                                            <label class="form-label small">URL Gambar</label>
                                                            <input type="text" class="form-control form-control-sm" readonly value="<%= tx.qr_url %>">
                                                        </div>
                                                        
                                                        <% if (tx.qr_base64) { %>
                                                            <div class="mb-2">
                                                                <label class="form-label small">Base64</label>
                                                                <textarea class="form-control form-control-sm" rows="2" readonly><%= tx.qr_base64 %></textarea>
                                                            </div>
                                                        <% } %>
                                                    <% } else { %>
                                                        <div class="d-flex align-items-center justify-content-center h-100 text-muted"><small>Tidak ada data QRIS untuk transaksi ini.</small></div>
                                                    <% } %>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <div class="d-lg-none">
        <% sortedTransactions.forEach(tx => { %>
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center small text-muted bg-light-subtle">
                    <code class="fw-semibold"><%= tx.transactionId %></code>
                    <span><%= new Date(tx.createdAt).toLocaleString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }) %></span>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-primary-subtle text-primary-emphasis mb-1"><%= tx.paymentMethod %></span><br>
                             <% if (tx.status === 'sukses') { %>
                                <span class="badge bg-success-subtle text-success-emphasis">Sukses</span>
                            <% } else if (tx.status === 'pending') { %>
                                <span class="badge bg-warning-subtle text-warning-emphasis">Pending</span>
                            <% } else { %>
                                <span class="badge bg-danger-subtle text-danger-emphasis">Gagal</span>
                            <% } %>
                        </div>
                        <div class="text-end">
                            <h5 class="fw-bold mb-0"><%= new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(tx.amount) %></h5>
                        </div>
                    </div>
                     <div class="collapse" id="details-mobile-<%= tx.transactionId %>">
                        <hr>
                        <div class="d-flex flex-wrap">
                            <div class="col-12">
                                <h6 class="mb-3 small">Rincian Pembayaran</h6>
                                <ul class="list-group list-group-flush small">
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">Deskripsi<span><%= tx.description %></span></li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">Jumlah Dasar<span><%= new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(tx.baseAmount || 0) %></span></li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">Biaya Admin<span><%= new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(tx.feeAmount || 0) %></span></li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">Kode Unik<span><%= new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(tx.uniqueNumber || 0) %></span></li>
                                    <% if (tx.status === 'pending' && tx.expiredAt) { %>
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent text-danger">Kedaluwarsa<span><%= new Date(tx.expiredAt).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) %></span></li>
                                    <% } %>
                                    <% if (tx.paymentUrl) { %>
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent">
                                            URL Pembayaran
                                            <div class="d-flex align-items-center gap-2">
                                                <a href="<%= tx.paymentUrl %>" target="_blank" class="btn btn-sm btn-outline-primary">Buka</a>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('<%= tx.paymentUrl %>', this)">
                                                    <i class="bi bi-copy"></i> Salin
                                                </button>
                                            </div>
                                        </li>
                                    <% } %>
                                </ul>
                            </div>
                            <% if (tx.qr_url) { %>
                                <div class="col-12 mt-3">
                                    <h6 class="mb-2 small">Data QRIS</h6>
                                    <img src="<%= tx.qr_url %>" class="img-fluid rounded border mb-3" style="max-width: 150px;" alt="QRIS Code">
                                    
                                    <div class="mb-2">
                                        <label class="form-label small">URL Gambar</label>
                                        <input type="text" class="form-control form-control-sm" readonly value="<%= tx.qr_url %>">
                                    </div>

                                     <% if (tx.qr_base64) { %>
                                        <div class="mb-2">
                                            <label class="form-label small">Base64</label>
                                            <textarea class="form-control form-control-sm" rows="2" readonly><%= tx.qr_base64 %></textarea>
                                        </div>
                                    <% } %>
                                </div>
                            <% } %>
                        </div>
                     </div>
                </div>
                <div class="card-footer d-flex justify-content-end align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-secondary flex-grow-1" type="button" data-bs-toggle="collapse" data-bs-target="#details-mobile-<%= tx.transactionId %>" aria-expanded="false">
                        <i class="bi bi-info-circle"></i> Detail
                    </button>
                    <% if (tx.status === 'pending') { %>
                        <form action="/member/transaction/update/<%= tx.transactionId %>" method="POST" class="flex-grow-1">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="pending" selected>Ubah Status</option>
                                <option value="sukses">Sukses</option>
                                <option value="gagal">Gagal</option>
                            </select>
                        </form>
                    <% } %>
                </div>
            </div>
        <% }) %>
    </div>
<% } else { %>
    <div class="card">
        <div class="card-body text-center p-5">
            <p class="mb-0">Belum ada riwayat transaksi.</p>
        </div>
    </div>
<% } %>

<%- include('./partials/footer') %>

<script>
    function copyToClipboard(text, buttonElement) {
        if (!navigator.clipboard) {
            alert("Clipboard API tidak didukung di browser ini.");
            return;
        }
        navigator.clipboard.writeText(text).then(() => {
            const originalContent = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="bi bi-check-lg"></i> Disalin!';
            buttonElement.disabled = true;
            setTimeout(() => {
                buttonElement.innerHTML = originalContent;
                buttonElement.disabled = false;
            }, 2000); // Reset after 2 detik
        }).catch(err => {
            console.error('Gagal menyalin teks: ', err);
            alert('Gagal menyalin teks.');
        });
    }
</script>