<%- include('./partials/header') %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Profil & Pengaturan Akun</h1>
</div>

<% if (success_messages.length > 0) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert"><%= success_messages[0] %></div>
<% } %>
<% if (error_messages.length > 0) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert"><%= error_messages[0] %></div>
<% } %>

<div class="row g-4">
    <div class="col-lg-4">
        <div class="card text-center h-100">
            <div class="card-body d-flex flex-column justify-content-center p-4">
                <img src="https://avatars.githubusercontent.com/u/99401498?v=4" class="rounded-circle mx-auto mb-3" width="80" height="80">
                <h5 class="mb-1"><%= user.name %></h5>
                <p class="text-muted small">@<%= user.username %></p>
                <% if (user.isAdmin) { %>
                    <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill align-self-center small">Administrator</span>
                <% } else { %>
                    <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill align-self-center small">User</span>
                <% } %>
                <hr class="my-3" style="border-color: var(--bs-border-color) !important;">
                <small class="text-muted">Bergabung Sejak</small>
                <p class="small mb-0"><%= new Date(user.createdAt).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }) %></p>
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="card mb-4">
             <div class="card-header bg-transparent border-0 pt-4 px-4">
                <h5 class="mb-0 h6">Informasi Pribadi</h5>
            </div>
            <div class="card-body p-4">
               <form action="/member/profile/update" method="POST">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <input type="hidden" name="action" value="update_info">
                    <!-- Form informasi pribadi (tidak berubah) -->
                    <div class="mb-3">
                        <label for="name" class="form-label small">Nama Lengkap</label>
                        <input type="text" class="form-control" id="name" name="name" value="<%= user.name %>">
                    </div>
                    <div class="mb-3">
                        <label for="no_telp" class="form-label small">Nomor Telepon</label>
                        <input type="tel" class="form-control" id="no_telp" name="no_telp" value="<%= user.no_telp %>">
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label small">Email</label>
                        <input type="email" class="form-control" id="email" value="<%= user.email %>" disabled>
                    </div>
                    <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-transparent border-0 pt-4 px-4">
                <h5 class="mb-0 h6">Pengaturan Toko</h5>
            </div>
            <div class="card-body p-4">
                <p class="small text-muted">Informasi ini akan ditampilkan kepada pembeli di halaman pembayaran publik.</p>
                <form action="/member/profile/update" method="POST">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <input type="hidden" name="action" value="update_store_info">
                    <div class="mb-3">
                        <label for="storeName" class="form-label small">Nama Toko</label>
                        <input type="text" class="form-control" id="storeName" name="storeName" value="<%= user.store && user.store.name ? user.store.name : '' %>" placeholder="Contoh: Toko WBK">
                    </div>
                    <div class="mb-3">
                        <label for="storeLogoUrl" class="form-label small">URL Logo Toko</label>
                        <input type="url" class="form-control" id="storeLogoUrl" name="storeLogoUrl" value="<%= user.store && user.store.logoUrl ? user.store.logoUrl : '' %>" placeholder="https://.../logo.png">
                    </div>
                    <button type="submit" class="btn btn-primary">Simpan Pengaturan Toko</button>
                </form>
                <hr class="my-4">
                <div class="mb-3">
                    <label for="storeUrl" class="form-label small">URL Toko Publik</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="storeUrl" value="<%= baseUrl %>/store/<%= user.username %>" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="copyStoreUrlBtn" title="Salin URL Toko"><i class="bi bi-clipboard"></i></button>
                        <a href="/store/<%= user.username %>" target="_blank" class="btn btn-outline-secondary" title="Kunjungi URL Toko"><i class="bi bi-box-arrow-up-right"></i></a>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-transparent border-0 pt-4 px-4">
                <h5 class="mb-0 h6">Pengaturan API</h5>
            </div>
            <div class="card-body p-4">
                <p class="small text-muted">Gunakan API key ini untuk mengautentikasi permintaan Anda ke endpoint pembayaran kami.</p>
                <div class="mb-3">
                    <label for="apiKey" class="form-label small">API Key Anda</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="apiKey" value="<%= user.apiKey || 'Belum tersedia' %>" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="copyBtn" title="Salin API Key"><i class="bi bi-clipboard"></i></button>
                    </div>
                </div>
                <form action="/member/profile/update" method="POST" onsubmit="return confirm('Apakah Anda yakin ingin membuat API Key baru? Kunci yang lama akan segera tidak valid.');">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <input type="hidden" name="action" value="regenerate_api_key">
                    <button type="submit" class="btn btn-danger">Buat Ulang API Key</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('copyBtn').addEventListener('click', function() {
        const apiKeyInput = document.getElementById('apiKey');
        apiKeyInput.select();
        apiKeyInput.setSelectionRange(0, 99999); 
        navigator.clipboard.writeText(apiKeyInput.value);
        this.innerHTML = '<i class="bi bi-clipboard-check-fill"></i>';
        this.title = 'Berhasil disalin!';
        setTimeout(() => { 
            this.innerHTML = '<i class="bi bi-clipboard"></i>';
            this.title = 'Salin API Key';
        }, 2000);
    });
</script>

<%- include('./partials/footer') %>
